<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dabarkads Fam Spin Wheel</title>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    text-align: center;
    padding-bottom: 50px;
  }

  h2 { margin-top: 15px; }

  input {
    width: 90%;
    max-width: 300px;
    padding: 12px;
    font-size: 16px;
    margin: 10px 0;
  }

  button {
    padding: 14px 30px;
    font-size: 18px;
    background: #f36b2c;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  button:disabled { background: gray; cursor: not-allowed; }

  /* Container to stack pointer over wheel */
  .wheel-container {
    position: relative;
    width: 360px;
    height: 360px;
    margin: 20px auto;
  }

  canvas {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  /* Pointer triangle pointing DOWN */
  .pointer {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 20px solid transparent;
    border-right: 20px solid transparent;
    border-top: 40px solid #333;
    z-index: 10;
  }

  .results {
    margin-top: 20px;
    background: white;
    padding: 10px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
    border-radius: 8px;
  }

  .admin {
    font-size: 12px;
    color: #ccc; /* Made it very light gray so it is less noticeable */
    margin-top: 30px;
    cursor: pointer;
  }
</style>
</head>
<body>

<h2>Dabarkads Fam</h2>

<input id="nameInput" placeholder="Enter Family name" autocomplete="off" />
<br />
<button id="spinBtn">SPIN</button>

<div class="wheel-container">
  <div class="pointer"></div>
  <canvas id="wheel" width="360" height="360"></canvas>
</div>

<div class="results">
  <h3>Results</h3>
  <ul id="resultsList" style="text-align: left;"></ul>
</div>

<div class="admin" onclick="adminReset()">Admin Reset</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // âœ… I ADDED YOUR CONFIG HERE FOR YOU
  const firebaseConfig = {
    apiKey: "AIzaSyC3-qUugEiiNbmK---LrQtCQsykO0rENwc",
    authDomain: "dabarkads-family-spin-wheel.firebaseapp.com",
    projectId: "dabarkads-family-spin-wheel",
    storageBucket: "dabarkads-family-spin-wheel.firebasestorage.app",
    messagingSenderId: "592721803535",
    appId: "1:592721803535:web:cefca927a5bb6b3b42667a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");
  const spinBtn = document.getElementById("spinBtn");
  const nameInput = document.getElementById("nameInput");

  // Wheel items
  let items = [
    "Beef","Beef1",
    "Chicken","Chicken1",
    "Pork","Pork1",
    "Fish","Fish1",
    "Drinks","Drink1",
    "Dessert","Dessert1",
    "Utensils"
  ];

  let currentAngle = 0;
  let spinning = false;

  function drawWheel(rotationAngle = 0) {
    const r = canvas.width / 2;
    const slice = (2 * Math.PI) / items.length;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    ctx.translate(r, r);
    ctx.rotate(rotationAngle * Math.PI / 180); 

    items.forEach((item, i) => {
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.fillStyle = `hsl(${i * 360 / items.length}, 70%, 60%)`;
        ctx.arc(0, 0, r, i * slice, (i + 1) * slice);
        ctx.lineTo(0, 0);
        ctx.fill();
        ctx.stroke();

        ctx.save();
        ctx.rotate(i * slice + slice / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#fff";
        ctx.font = "bold 14px Arial";
        ctx.fillText(item, r - 20, 5);
        ctx.restore();
    });

    ctx.restore();
  }

  async function spin() {
    let name = nameInput.value.trim();
    if (!name || spinning) return alert("Enter a family name");

    // âœ… This line makes the first letter Uppercase and the rest lowercase
    name = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();

    const ref = doc(db, "spins", name);
    try {
      if ((await getDoc(ref)).exists()) {
        return alert(`${name} already spun.`);
      }
    } catch (e) {
      console.error(e);
      return alert("Database error. Check console.");
    }
    
    // ... rest of the spin function remains the same

    spinning = true;
    spinBtn.disabled = true;

    const spinDuration = 4000;
    const extraSpins = 360 * 5; 
    const randomStop = Math.random() * 360;
    const totalRotation = extraSpins + randomStop;
    
    const start = performance.now();
    const startAngle = currentAngle;

    function animate(time) {
      const elapsed = time - start;
      const p = Math.min(elapsed / spinDuration, 1);
      const ease = 1 - Math.pow(1 - p, 4);
      
      currentAngle = startAngle + (totalRotation * ease);
      drawWheel(currentAngle);

      if (p < 1) {
        requestAnimationFrame(animate);
      } else {
        finishSpin(name);
      }
    }
    
    requestAnimationFrame(animate);
  }

  async function finishSpin(name) {
    const actualAngle = currentAngle % 360;
    const sliceDeg = 360 / items.length;
    let index = Math.floor((360 - actualAngle + 270) % 360 / sliceDeg);
    index = (items.length + index) % items.length;

    const item = items[index];

    await setDoc(doc(db, "spins", name), { 
      name: name,
      item: item,
      timestamp: new Date()
    });

    // Remove item from wheel
    items.splice(index, 1);

    spinning = false;
    spinBtn.disabled = false;
    nameInput.value = ""; 
    
    loadResults();
    drawWheel(currentAngle);
    alert(`Congratulations ${name}! You got: ${item}`);
  }

  async function loadResults(){
    const list = document.getElementById("resultsList");
    try {
      const snap = await getDocs(collection(db, "spins"));
      list.innerHTML = "";
      if(snap.empty) {
        list.innerHTML = "<li>No results yet.</li>";
        return;
      }
      snap.forEach(d => {
        const li = document.createElement("li");
        li.textContent = `${d.id} â€“ ${d.data().item}`;
        list.appendChild(li);
      });
    } catch (e) {
      list.innerHTML = "Error loading results.";
    }
  }

  // ðŸ”’ PASSWORD PROTECTED RESET
  async function adminReset() {
    // 1. Ask for password
    const password = prompt("Enter Admin Password to reset:");
    
    // 2. Check password (I set it to 4321)
    if (password !== "4321") {
        return alert("Wrong password! Permission denied.");
    }

    if(!confirm("Are you sure you want to delete all data?")) return;
    const snap = await getDocs(collection(db, "spins"));
    for(const d of snap.docs){
      await deleteDoc(d.ref);
    }
    location.reload();
  }

  window.adminReset = adminReset;
  spinBtn.onclick = spin;

  drawWheel(currentAngle);
  loadResults();
</script>

</body>
</html>