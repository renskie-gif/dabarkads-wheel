<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dabarkads Fam Spin Wheel</title>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Poppins:wght@400;700&display=swap" rel="stylesheet">

<style>
  body { 
    margin: 0; 
    font-family: 'Poppins', sans-serif; 
    background: radial-gradient(circle, #ffffff 0%, #e8e8e8 100%); 
    text-align: center; 
    padding-bottom: 50px; 
    color: #333;
  }

  /* Cool Framed Title Boarder */
  .title-container {
    margin: 30px auto;
    display: inline-block;
    padding: 10px 40px;
    border: 4px solid #f36b2c;
    border-radius: 50px 15px 50px 15px;
    background-color: white;
    box-shadow: 0 6px 0 #d35400;
  }

  h2 { 
    margin: 0; 
    font-family: 'Luckiest Guy', cursive; 
    font-size: 32px; 
    letter-spacing: 2px;
    color: #f36b2c;
    text-shadow: 2px 2px 0px #fff, 4px 4px 0px rgba(0,0,0,0.1);
  }

  input { 
    width: 80%; 
    max-width: 300px; 
    padding: 15px; 
    font-size: 16px; 
    margin: 10px 0; 
    border: 2px solid #ddd; 
    border-radius: 25px; 
    outline: none; 
    text-align: center;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
  }

  input:focus { border-color: #f36b2c; border-width: 2px; }

  button { 
    padding: 15px 50px; 
    font-size: 20px; 
    font-family: 'Luckiest Guy', cursive;
    background: linear-gradient(to bottom, #f36b2c, #d35400);
    color: white; 
    border: none; 
    border-radius: 50px; 
    cursor: pointer; 
    box-shadow: 0 5px 0 #a04000;
    margin-bottom: 20px;
    animation: glow 2s infinite;
  }

  button:active { transform: translateY(3px); box-shadow: 0 2px 0 #a04000; }
  button:disabled { background: #ccc; box-shadow: 0 5px 0 #999; animation: none; }

  @keyframes glow {
    0% { box-shadow: 0 5px 0 #a04000, 0 0 5px rgba(243, 107, 44, 0.2); }
    50% { box-shadow: 0 5px 0 #a04000, 0 0 20px rgba(243, 107, 44, 0.6); }
    100% { box-shadow: 0 5px 0 #a04000, 0 0 5px rgba(243, 107, 44, 0.2); }
  }

  /* Larger Wheel Container for better visibility */
  .wheel-container { 
    position: relative; 
    width: 380px; 
    height: 380px; 
    margin: 20px auto; 
    border: 12px solid #333; 
    border-radius: 50%;
    background: #333;
    box-shadow: 0 15px 30px rgba(0,0,0,0.3);
  }

  canvas { width: 100%; height: 100%; border-radius: 50%; background: white; }

  .pointer { 
    position: absolute; 
    top: -28px; 
    left: 50%; 
    transform: translateX(-50%); 
    width: 0; 
    height: 0; 
    border-left: 20px solid transparent; 
    border-right: 20px solid transparent; 
    border-top: 45px solid #ff0000; 
    z-index: 10; 
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
  }

  .results { 
    margin-top: 40px; 
    background: white; 
    padding: 25px; 
    max-width: 480px; 
    margin: auto; 
    border-radius: 20px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
  }

  .result-item { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 12px 5px; 
    border-bottom: 1px solid #eee; 
  }

  .result-name { font-weight: 700; color: #333; font-size: 15px; }
  .result-item-won { color: #f36b2c; font-weight: 700; }
  .result-time { color: #aaa; font-size: 11px; white-space: nowrap; }

  .admin { font-size: 11px; color: #ddd; margin-top: 60px; cursor: pointer; }
</style>
</head>
<body>

<div class="title-container">
  <h2>DABARKADS FAMILY</h2>
</div>

<br>
<input id="nameInput" placeholder="Enter Family Name" autocomplete="off" />
<br />
<button id="spinBtn">SPIN THE WHEEL</button>

<div class="wheel-container">
  <div class="pointer"></div>
  <canvas id="wheel" width="500" height="500"></canvas>
</div>

<div class="results">
  <h3 style="font-family: 'Luckiest Guy'; font-size: 24px;">ðŸŽ‰ Family List</h3>
  <ul id="resultsList"></ul>
</div>

<div class="admin" onclick="adminReset()">Admin Reset</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC3-qUugEiiNbmK---LrQtCQsykO0rENwc",
    authDomain: "dabarkads-family-spin-wheel.firebaseapp.com",
    projectId: "dabarkads-family-spin-wheel",
    storageBucket: "dabarkads-family-spin-wheel.firebasestorage.app",
    messagingSenderId: "592721803535",
    appId: "1:592721803535:web:cefca927a5bb6b3b42667a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");
  const spinBtn = document.getElementById("spinBtn");
  const nameInput = document.getElementById("nameInput");

  let items = ["Beef","Beef1","Chicken","Chicken1","Pork","Pork1","Fish","Fish1","Drinks","Drink1","Dessert","Dessert1","Utensils"];
  let currentAngle = 0;
  let spinning = false;

  function drawWheel(rotationAngle = 0) {
    const r = canvas.width / 2;
    const slice = (2 * Math.PI) / items.length;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (items.length === 0) {
        ctx.save();
        ctx.translate(r, r);
        ctx.font = "bold 24px Poppins";
        ctx.textAlign = "center";
        ctx.fillText("All Prizes Won!", 0, 0);
        ctx.restore();
        return;
    }

    ctx.save();
    ctx.translate(r, r);
    ctx.rotate(rotationAngle * Math.PI / 180); 
    items.forEach((item, i) => {
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.fillStyle = `hsl(${i * 360 / items.length}, 75%, 55%)`;
        ctx.arc(0, 0, r, i * slice, (i + 1) * slice);
        ctx.lineTo(0, 0);
        ctx.fill();
        ctx.strokeStyle = "white";
        ctx.lineWidth = 2;
        ctx.stroke();
        
        ctx.save();
        ctx.rotate(i * slice + slice / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#fff";
        // âœ… BIGGER FONT FOR WHEEL
        ctx.font = "bold 20px Poppins"; 
        ctx.fillText(item, r - 30, 8);
        ctx.restore();
    });
    ctx.restore();
  }

  async function spin() {
    let rawName = nameInput.value.trim();
    if (!rawName || spinning) return alert("Please enter a name!");
    if (items.length === 0) return alert("No more items left!");

    let capitalized = rawName.charAt(0).toUpperCase() + rawName.slice(1).toLowerCase();
    let fullName = capitalized.includes("Family") ? capitalized : capitalized + " Family";

    const ref = doc(db, "spins", fullName);
    const docSnap = await getDoc(ref);
    if (docSnap.exists()) return alert(fullName + " has already spun!");

    spinning = true;
    spinBtn.disabled = true;

    const spinDuration = 5000;
    const totalRotation = (360 * 12) + (Math.random() * 360);
    const start = performance.now();
    const startAngle = currentAngle;

    function animate(time) {
      const elapsed = time - start;
      const p = Math.min(elapsed / spinDuration, 1);
      const ease = 1 - Math.pow(1 - p, 4);
      currentAngle = startAngle + (totalRotation * ease);
      drawWheel(currentAngle);
      if (p < 1) requestAnimationFrame(animate);
      else finishSpin(fullName);
    }
    requestAnimationFrame(animate);
  }

  async function finishSpin(fullName) {
    const actualAngle = currentAngle % 360;
    const sliceDeg = 360 / items.length;
    let index = Math.floor((360 - actualAngle + 270) % 360 / sliceDeg);
    index = (items.length + index) % items.length;
    const wonItem = items[index];

    await setDoc(doc(db, "spins", fullName), { name: fullName, item: wonItem, time: Date.now() });
    
    confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });
    spinning = false;
    spinBtn.disabled = false;
    nameInput.value = ""; 
    
    resetItemsList(); 
    loadResults();
    alert("ðŸŽ‰ " + fullName + " won: " + wonItem);
  }

  function resetItemsList() {
      items = ["Beef","Beef1","Chicken","Chicken1","Pork","Pork1","Fish","Fish1","Drinks","Drink1","Dessert","Dessert1","Utensils"];
  }

  async function loadResults() {
    const list = document.getElementById("resultsList");
    try {
      const snap = await getDocs(collection(db, "spins"));
      let allSpins = [];
      resetItemsList();
      snap.forEach(d => {
          let data = d.data();
          allSpins.push({ id: d.id, ...data });
          const itemIdx = items.indexOf(data.item);
          if (itemIdx > -1) items.splice(itemIdx, 1);
      });
      drawWheel(currentAngle);
      allSpins.sort((a, b) => (b.time || 0) - (a.time || 0));
      list.innerHTML = "";
      allSpins.forEach(data => {
        let timeStr = data.time ? new Date(data.time).toLocaleString([], {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}) : "---";
        const li = document.createElement("li");
        li.className = "result-item";
        li.innerHTML = `
          <div>
            <span class="result-name">${data.id}</span> 
            <span style="color:#888; font-size:12px; margin:0 4px;">won</span> 
            <span class="result-item-won">${data.item}</span>
          </div>
          <div class="result-time">${timeStr}</div>`;
        list.appendChild(li);
      });
    } catch (e) { console.error(e); }
  }

  window.adminReset = async () => {
    const pw = prompt("Admin Password:");
    if (pw !== "1234") return alert("Wrong password");
    if (!confirm("Delete all data and reset the wheel?")) return;
    const snap = await getDocs(collection(db, "spins"));
    for(const d of snap.docs) await deleteDoc(d.ref);
    location.reload();
  };

  spinBtn.onclick = spin;
  loadResults();
</script>
</body>
</html>
